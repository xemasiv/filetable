var _createClass=function(){function t(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}();function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var sha3_256=window.sha3_256,EventEmitter3=window.EventEmitter3,localforage=window.localforage,async=window.async;console.log("sha3_256:",sha3_256),console.log("EventEmitter3:",EventEmitter3),console.log("localforage:",localforage),console.log("async:",async);var FileTable=function(){function r(){_classCallCheck(this,r),this._files=[],this._chunks={};var t=new EventEmitter3;this.on=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];t.on.apply(t,r)},this.emit=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];t.emit.apply(t,r)};var e=async.queue(function(e,r){e(r)});this._queue=e}return _createClass(r,[{key:"bind",value:function(e){var t=this,o=this;$(e).change(function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];t.queueFile.apply(o,r)})}},{key:"queueFile",value:function(e){var r=this,n=this._queue,t=e.target.files;console.log(t),Object.keys(t).map(function(e){n.push(r.processFile(t[e]),function(){r.emit("new_file")})})}},{key:"processFile",value:function(e){var d=this;return function(a){var i=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,u=256e3,s=Math.ceil(e.size/u),c=0,l=sha3_256.create(),f=[];!function t(o){var e=new FileReader;e.onload=function(e){if(f.push(e.target.result),l.update(e.target.result),++c<s)t(o);else{var r=l.hex(),n={name:o.name,type:o.type,hash:r,chunkSize:u,chunkCount:c};d._files.push(n),d._chunks[r]=f,d.emit("new_file",n),a()}},e.onerror=function(){console.log("fileReader error.")};var r=c*u,n=r+u>=o.size?o.size:r+u;e.readAsArrayBuffer(i.call(o,r,n))}(e)}}},{key:"getFiles",value:function(){return this._files}},{key:"getChunks",value:function(){return this._chunks}},{key:"getFileChunk",value:function(e,r){return this._chunks[e][r]}}]),r}(),VideoChunkLoader=function(){function u(e,r,n){_classCallCheck(this,u);var t=this,o=new EventEmitter3;t.on=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];o.on.apply(o,r)},t.emit=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];o.emit.apply(o,r)};var a=[];switch(r){case"video/webm":a=["vp8","vorbis","vp8,vorbis"];break;default:return void t.emit("error",new Error("UNKNOWN FILE TYPE"))}var i=async.queue(function(e,r){e(r)});i.pause(),t._videoElement=e,t._fileType=r,t._codecIndex=-1,t._codecSource=a,t._queue=i,t._targetChunks=n,t._processedArrayBuffers=[],t.assignMediaSource()}return _createClass(u,[{key:"assignMediaSource",value:function(){var n=this;n._codecIndex=n._codecIndex+1;var t="".concat(n._fileType,";codecs=",'"',n._codecSource[n._codecIndex],'"');if(n.emit("try_mimetype",t),n._codecIndex>n._codecSource.length-1)n.emit("error",new Error("MIMETYPE OPTIONS"));else{var o=new MediaSource;n._videoElement.prop("src",window.URL.createObjectURL(o));var a=n._queue;o.addEventListener("sourceopen",function e(){var r=o.addSourceBuffer(t);n._sourceBuffer=r,o.removeEventListener("sourceopen",e),n._processedArrayBuffers.map(function(e){a.unshift(n.processArrayBuffer(e),function(){n.emit("append_ok")})}),n._processedArrayBuffers=[],a.resume()}),n._mediaSource=o,n._loadedChunks=-1}}},{key:"pushArrayBuffer",value:function(e){var r=this;this._queue.push(r.processArrayBuffer(e),function(){r.emit("append_ok")})}},{key:"processArrayBuffer",value:function(o){var a=this,i=a._queue;return function(r){var n=a._sourceBuffer,t=a._mediaSource;try{n.appendBuffer(new Uint8Array(o)),n.addEventListener("updateend",function e(){a._loadedChunks=a._loadedChunks+1,a._processedArrayBuffers.push(o),a._loadedChunks===a._targetChunks&&(n.updating||"open"!==t.readyState||(t.endOfStream(),a.emit("done"))),n.removeEventListener("updateend",e),r()})}catch(e){i.pause(),r(),a._processedArrayBuffers.push(o),a.assignMediaSource()}}}}]),u}();window.FileTable=FileTable,window.VideoChunkLoader=VideoChunkLoader;